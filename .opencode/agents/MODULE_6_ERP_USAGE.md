# ERP Module - Project Budget Management

## Обзор модуля

Модуль управления проектами и бюджетами позволяет:
- Отслеживать договоренную сумму сделки с клиентом
- Планировать бюджет на выполнение работ
- Учитывать фактические расходы
- Анализировать отклонения, прибыльность и прогнозы

## Структура данных

### Проекты (projects)

```sql
- id: INTEGER - ID проекта
- name: VARCHAR(255) - Название проекта
- client_id: UUID - Ссылка на клиента
- lead_id: UUID - Ссылка на лид (сделку) в CRM
- deal_amount: DECIMAL(12,2) - Сумма сделки с клиентом
- budget_amount: DECIMAL(12,2) - Плановый бюджет на выполнение
- currency: VARCHAR(3) - Валюта (по умолчанию PLN)
- status: VARCHAR(50) - Статус (active, completed, cancelled)
- start_date: DATE - Дата начала
- end_date: DATE - Дата окончания
- description: TEXT - Описание проекта
```

### Расходы (expenses)

```sql
- id: INTEGER - ID расхода
- project_id: INTEGER - Ссылка на проект
- amount: DECIMAL(12,2) - Сумма расхода
- category: VARCHAR(100) - Категория (materials, labor, transport, etc.)
- description: TEXT - Описание
- expense_date: DATE - Дата расхода
- receipt_url: VARCHAR(500) - URL загруженного чека
- created_by: UUID - Кто добавил
```

## API Endpoints

### Проекты

**GET /api/projects**
- Получить список всех проектов
- Query params: client_id, status

**GET /api/projects/:id**
- Получить детальную информацию о проекте

**POST /api/projects**
- Создать новый проект
```json
{
  "name": "Ремонт офиса",
  "client_id": "uuid",
  "deal_amount": 50000,
  "budget_amount": 35000,
  "start_date": "2026-01-01",
  "end_date": "2026-03-01",
  "description": "Полный ремонт офиса"
}
```

**PUT /api/projects/:id**
- Обновить проект

**DELETE /api/projects/:id**
- Удалить проект

**GET /api/projects/:id/analytics**
- Получить аналитику с прогнозами
- Возвращает:
  - summary: суммы, проценты, прибыль
  - variance: отклонения от бюджета
  - forecast: прогнозы (daily burn rate, projected cost)
  - risk: оценка рисков (low/medium/high/critical)
  - trends: тренды по месяцам

### Расходы

**GET /api/expenses**
- Получить список расходов
- Query params: project_id, category, start_date, end_date

**POST /api/expenses**
- Добавить расход
```json
{
  "project_id": 1,
  "amount": 1500,
  "category": "materials",
  "description": "Краска и кисти",
  "expense_date": "2026-01-07"
}
```

**POST /api/expenses/upload-receipt**
- Загрузить чек (multipart/form-data)
- Возвращает URL для привязки к расходу

## Аналитика

### Автоматически рассчитываемые показатели:

1. **Базовые метрики**
   - total_spent - Сумма всех расходов
   - remaining - Остаток бюджета
   - spent_percentage - % использования бюджета

2. **Прибыльность**
   - profit = deal_amount - total_spent
   - profit_margin = (profit / deal_amount) * 100

3. **Прогнозы**
   - daily_burn_rate - Средний расход в день
   - projected_total_cost - Прогноз итоговых затрат
   - days_of_budget_remaining - Дней до исчерпания бюджета

4. **Риски**
   - low: < 75% бюджета
   - medium: 75-90% бюджета
   - high: 90-100% бюджета
   - critical: > 100% бюджета

## Frontend страницы

### /projects
- Список всех проектов в виде карточек
- Показывает: сумму сделки, бюджет, расходы, прибыль
- Визуальный индикатор использования бюджета
- Форма создания нового проекта

### /projects/[id]
- Детальная информация о проекте
- Ключевые метрики (сумма сделки, бюджет, расходы, прибыль)
- Прогнозы и аналитика
- Оценка рисков с цветовой индикацией
- Таблица всех расходов
- Форма добавления нового расхода

## Использование

### Создание проекта

1. После согласования сделки с клиентом, создайте проект
2. Укажите:
   - **Сумма сделки** - то, что согласовали с клиентом
   - **Плановый бюджет** - сколько планируете потратить
   - Даты начала и окончания

### Добавление расходов

1. Перейдите в детализацию проекта
2. Нажмите "Добавить расход"
3. Заполните:
   - Сумма
   - Категория (материалы, работа, транспорт и т.д.)
   - Описание
   - Дата
4. Опционально: загрузите чек

### Мониторинг

**Ключевые показатели для контроля:**

- **Прибыль** - должна быть положительной
- **% использования бюджета** - следите чтобы не превысить 100%
- **Средний расход в день** - помогает понять темп трат
- **Прогноз итоговых затрат** - покажет перерасход заранее

**Система алертов:**
- При 80% бюджета - предупреждение
- При 100% бюджета - критическое предупреждение

## Миграции

Для применения схемы БД выполните:

```bash
# Основная миграция ERP
psql $DATABASE_URL -f database/erp_migration.sql

# Миграция с добавлением deal_amount и аналитики
psql $DATABASE_URL -f database/migrations/006_add_deal_amount_to_projects.sql
```

## Расширение функционала

### Будущие улучшения:

1. **OCR для чеков** - автоматическое распознавание сумм
2. **Интеграция с банком** - автоматическая загрузка транзакций
3. **Графики и дашборды** - визуализация трендов
4. **Экспорт отчетов** - в PDF, Excel
5. **Уведомления** - при превышении бюджета
6. **Связь с leads** - автоматическое создание проекта из сделки

## Техническая информация

**Backend:** Node.js + Express
**Frontend:** Next.js (React)
**База данных:** PostgreSQL
**Миграции:** SQL файлы в /database/migrations/

---

**Статус:** ✅ Базовый функционал готов к использованию
**Версия:** 1.0
**Дата:** 2026-01-07

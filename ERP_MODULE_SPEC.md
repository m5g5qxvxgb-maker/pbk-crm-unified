# 📊 ERP MODULE - Управление расходами и бюджетами

**Дата создания:** 10 декабря 2024  
**Версия:** 1.0

═══════════════════════════════════════════════════════════════

## 🎯 ОПИСАНИЕ МОДУЛЯ

Модуль ERP для управления финансами, расходами и бюджетированием проектов.

### Основные функции:

1. **Затраты по клиентам (Projects)**
   - Загрузка расходов на каждого клиента/проект
   - Сравнение с заложенным бюджетом
   - Отслеживание остатка бюджета
   - История всех затрат

2. **Общие расходы бизнеса**
   - Фиксация общих затрат (не привязанных к клиентам)
   - Категоризация расходов
   - Месячные итоги
   - Отчёты по периодам

3. **Telegram Bot интеграция**
   - Быстрая фиксация расходов через бота
   - Загрузка фото чеков
   - Автоматическое распознавание (OCR опционально)
   - Интерактивные уточнения
   - Мгновенные сводки

═══════════════════════════════════════════════════════════════

## 🗄️ DATABASE SCHEMA

### 1. Таблица `projects` (расширение `clients`)

```sql
CREATE TABLE projects (
  id SERIAL PRIMARY KEY,
  client_id INTEGER REFERENCES clients(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  
  -- Бюджет
  budget_amount DECIMAL(12, 2) NOT NULL DEFAULT 0,
  currency VARCHAR(3) DEFAULT 'PLN',
  
  -- Статус
  status VARCHAR(50) DEFAULT 'active', -- active, completed, cancelled
  
  -- Даты
  start_date DATE,
  end_date DATE,
  
  -- Метаданные
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER REFERENCES users(id)
);

CREATE INDEX idx_projects_client ON projects(client_id);
CREATE INDEX idx_projects_status ON projects(status);
```

### 2. Таблица `expenses` (все расходы)

```sql
CREATE TABLE expenses (
  id SERIAL PRIMARY KEY,
  
  -- Привязка
  project_id INTEGER REFERENCES projects(id) ON DELETE SET NULL, -- NULL = общие расходы
  client_id INTEGER REFERENCES clients(id) ON DELETE SET NULL,
  
  -- Сумма
  amount DECIMAL(12, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'PLN',
  
  -- Категория
  category VARCHAR(100) NOT NULL, -- materials, labor, equipment, transport, general, etc.
  subcategory VARCHAR(100),
  
  -- Описание
  description TEXT NOT NULL,
  notes TEXT,
  
  -- Чек/Документ
  receipt_url VARCHAR(500), -- ссылка на фото чека
  receipt_number VARCHAR(100),
  
  -- Дата расхода
  expense_date DATE NOT NULL,
  
  -- Кто добавил
  created_by INTEGER REFERENCES users(id),
  created_via VARCHAR(50) DEFAULT 'web', -- web, telegram, api
  
  -- Telegram связанные данные
  telegram_message_id BIGINT,
  telegram_user_id BIGINT,
  
  -- Метаданные
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_expenses_project ON expenses(project_id);
CREATE INDEX idx_expenses_client ON expenses(client_id);
CREATE INDEX idx_expenses_date ON expenses(expense_date);
CREATE INDEX idx_expenses_category ON expenses(category);
CREATE INDEX idx_expenses_created_by ON expenses(created_by);
```

### 3. Таблица `expense_categories` (справочник категорий)

```sql
CREATE TABLE expense_categories (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  name_ru VARCHAR(100),
  name_pl VARCHAR(100),
  parent_category VARCHAR(100), -- для subcategories
  icon VARCHAR(20), -- emoji или иконка
  color VARCHAR(20), -- для UI
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Заполним базовыми категориями
INSERT INTO expense_categories (name, name_ru, name_pl, icon, color) VALUES
  ('materials', 'Материалы', 'Materiały', '🛠️', '#FF9800'),
  ('labor', 'Работа', 'Praca', '👷', '#2196F3'),
  ('equipment', 'Оборудование', 'Sprzęt', '🔧', '#9C27B0'),
  ('transport', 'Транспорт', 'Transport', '🚚', '#4CAF50'),
  ('subcontractors', 'Субподрядчики', 'Podwykonawcy', '🤝', '#FF5722'),
  ('general', 'Общие расходы', 'Wydatki ogólne', '💰', '#607D8B'),
  ('office', 'Офис', 'Biuro', '🏢', '#795548'),
  ('marketing', 'Маркетинг', 'Marketing', '📢', '#E91E63'),
  ('utilities', 'Коммунальные', 'Usługi komunalne', '💡', '#00BCD4'),
  ('other', 'Прочее', 'Inne', '📋', '#9E9E9E');
```

### 4. Таблица `budget_alerts` (оповещения о бюджете)

```sql
CREATE TABLE budget_alerts (
  id SERIAL PRIMARY KEY,
  project_id INTEGER REFERENCES projects(id) ON DELETE CASCADE,
  
  -- Тип алерта
  alert_type VARCHAR(50) NOT NULL, -- threshold_reached, budget_exceeded, low_balance
  threshold_percentage INTEGER, -- например, 80% бюджета
  
  -- Данные
  message TEXT,
  is_sent BOOLEAN DEFAULT false,
  sent_at TIMESTAMP,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

═══════════════════════════════════════════════════════════════

## 📱 API ENDPOINTS

### Projects API (`/api/projects`)

```javascript
// Проекты
GET    /api/projects                    // Список всех проектов
GET    /api/projects/:id                // Детали проекта
POST   /api/projects                    // Создать проект
PUT    /api/projects/:id                // Обновить проект
DELETE /api/projects/:id                // Удалить проект

// Финансы проекта
GET    /api/projects/:id/budget         // Бюджет и статистика
GET    /api/projects/:id/expenses       // Все расходы проекта
POST   /api/projects/:id/expenses       // Добавить расход
GET    /api/projects/:id/summary        // Сводка по проекту

// Отчёты
GET    /api/projects/:id/report         // Финансовый отчёт
```

### Expenses API (`/api/expenses`)

```javascript
// CRUD расходов
GET    /api/expenses                    // Список всех расходов (с фильтрами)
GET    /api/expenses/:id                // Детали расхода
POST   /api/expenses                    // Добавить расход
PUT    /api/expenses/:id                // Обновить расход
DELETE /api/expenses/:id                // Удалить расход

// Загрузка чеков
POST   /api/expenses/upload-receipt     // Загрузить фото чека
POST   /api/expenses/ocr                // OCR распознавание чека

// Статистика
GET    /api/expenses/stats              // Общая статистика
GET    /api/expenses/by-category        // Расходы по категориям
GET    /api/expenses/by-project         // Расходы по проектам
GET    /api/expenses/monthly            // Месячные итоги
```

### Categories API (`/api/expense-categories`)

```javascript
GET    /api/expense-categories          // Список категорий
POST   /api/expense-categories          // Создать категорию
PUT    /api/expense-categories/:id      // Обновить
DELETE /api/expense-categories/:id      // Удалить
```

═══════════════════════════════════════════════════════════════

## 🤖 TELEGRAM BOT СЦЕНАРИИ

### Сценарий 1: Добавление расхода по клиенту

**Пользователь:**
> Закупил для клиента "Иван" материалы на сумму 500

**Бот:**
```
📊 Добавление расхода

Клиент: Иван Петров
Сумма: 500 PLN

Выберите проект:
1️⃣ Ремонт квартиры ул. Пушкина
2️⃣ Офис на Невском

Или отправьте /cancel
```

**Пользователь:** 1

**Бот:**
```
📦 Категория расхода:

🛠️ Материалы
👷 Работа
🔧 Оборудование
🚚 Транспорт
🤝 Субподрядчики
📋 Прочее

Выберите номер или напишите название
```

**Пользователь:** 1

**Бот:**
```
📝 Краткое описание расхода:
(Например: "Цемент, песок, кирпичи")
```

**Пользователь:** Краска, валики, кисти

**Бот:**
```
✅ Расход добавлен!

📊 Проект: Ремонт квартиры ул. Пушкина
💰 Расход: 500 PLN (Материалы)
📝 Описание: Краска, валики, кисти

📈 Сводка по проекту:
━━━━━━━━━━━━━━━━━━━━
Бюджет:     10,000 PLN
Потрачено:   3,500 PLN ███████░░░ 35%
Осталось:    6,500 PLN

Категории:
🛠️ Материалы:      2,100 PLN
👷 Работа:          1,200 PLN
🚚 Транспорт:         200 PLN

Последние расходы:
• 500 PLN - Краска, валики, кисти (сегодня)
• 300 PLN - Цемент (вчера)
• 400 PLN - Доставка материалов (3 дня назад)
```

### Сценарий 2: Добавление с фото чека

**Пользователь:** [Отправляет фото чека]

**Бот:**
```
📸 Получил фото чека!

Укажите сумму и описание:
Например: "500 материалы для Ивана"

Или я могу попробовать распознать чек автоматически:
/ocr - распознать чек
/manual - ввести вручную
```

**Пользователь:** /ocr

**Бот:**
```
🔍 Распознаю чек...

✅ Распознано:
Сумма: 487.50 PLN
Дата: 10.12.2024
Магазин: Leroy Merlin

Подтвердите или измените данные:
/confirm - всё верно
/edit - изменить
```

### Сценарий 3: Общие расходы

**Пользователь:**
> Оплатил интернет 100 злотых

**Бот:**
```
💼 Общий расход

Сумма: 100 PLN
Описание: Оплатил интернет

Это общий расход бизнеса?
1️⃣ Да, общие расходы
2️⃣ Нет, для проекта

Или отправьте название клиента/проекта
```

**Пользователь:** 1

**Бот:**
```
📦 Категория:

🏢 Офис
📢 Маркетинг
💡 Коммунальные
💰 Общие
📋 Прочее
```

**Пользователь:** 3

**Бот:**
```
✅ Общий расход добавлен!

💼 Категория: Коммунальные
💰 Сумма: 100 PLN
📝 Описание: Оплатил интернет

📊 Общие расходы за декабрь:
━━━━━━━━━━━━━━━━━━━━
Всего: 2,350 PLN

По категориям:
🏢 Офис:          800 PLN
💡 Коммунальные:  650 PLN
📢 Маркетинг:     500 PLN
💰 Общие:         400 PLN

/monthly - месячный отчёт
/stats - детальная статистика
```

### Сценарий 4: Быстрый запрос сводки

**Пользователь:**
> /project Иван

**Бот:**
```
📊 Проекты клиента Иван Петров:

1️⃣ Ремонт квартиры ул. Пушкина
   Бюджет: 10,000 PLN
   Потрачено: 3,500 PLN (35%)
   Осталось: 6,500 PLN
   Статус: ✅ В работе

2️⃣ Балкон
   Бюджет: 3,000 PLN
   Потрачено: 2,800 PLN (93%)
   ⚠️ Осталось: 200 PLN
   Статус: 🔜 Завершается

/details_1 - подробно по проекту 1
/details_2 - подробно по проекту 2
```

═══════════════════════════════════════════════════════════════

## 🎨 FRONTEND UI

### 1. Projects Page (`/app/projects`)

**Список проектов:**
```
╔════════════════════════════════════════════════════╗
║  📊 Проекты                          [+ Новый]    ║
╠════════════════════════════════════════════════════╣
║                                                    ║
║  🔵 Ремонт квартиры - Иван Петров                ║
║     Бюджет: 10,000 PLN | Потрачено: 35%          ║
║     ██████████░░░░░░░░░░░░░░░░░░░░                ║
║                                          [Открыть] ║
║  ─────────────────────────────────────────────    ║
║  🟢 Офис - ООО "Рога и Копыта"                   ║
║     Бюджет: 50,000 PLN | Потрачено: 62%          ║
║     ████████████████░░░░░░░░░░░░░░                ║
║                                          [Открыть] ║
║  ─────────────────────────────────────────────    ║
║  🟡 Балкон - Мария Сидорова                      ║
║     Бюджет: 3,000 PLN | Потрачено: 93% ⚠️        ║
║     ██████████████████████████░░░░                ║
║                                          [Открыть] ║
╚════════════════════════════════════════════════════╝
```

### 2. Project Details Page (`/app/projects/:id`)

```
╔════════════════════════════════════════════════════╗
║  📊 Ремонт квартиры - Иван Петров                 ║
║  [Редактировать] [Добавить расход] [Отчёт]       ║
╠════════════════════════════════════════════════════╣
║                                                    ║
║  💰 БЮДЖЕТ                                        ║
║  ┌──────────────────────────────────────────┐    ║
║  │ Заложено:    10,000 PLN                  │    ║
║  │ Потрачено:    3,500 PLN (35%)            │    ║
║  │ Осталось:     6,500 PLN                  │    ║
║  │                                           │    ║
║  │ ███████░░░░░░░░░░░░░░░░░░░░               │    ║
║  └──────────────────────────────────────────┘    ║
║                                                    ║
║  📊 РАСХОДЫ ПО КАТЕГОРИЯМ                        ║
║  ┌──────────────────────────────────────────┐    ║
║  │ 🛠️ Материалы          2,100 PLN  60%    │    ║
║  │ 👷 Работа              1,200 PLN  34%    │    ║
║  │ 🚚 Транспорт             200 PLN   6%    │    ║
║  └──────────────────────────────────────────┘    ║
║                                                    ║
║  📝 ПОСЛЕДНИЕ РАСХОДЫ                            ║
║  ┌──────────────────────────────────────────┐    ║
║  │ 10.12 | 500 PLN | Краска, кисти         │    ║
║  │ 09.12 | 300 PLN | Цемент                │    ║
║  │ 07.12 | 400 PLN | Доставка              │    ║
║  │ 05.12 | 800 PLN | Работа маляра         │    ║
║  │                          [Показать все →] │    ║
║  └──────────────────────────────────────────┘    ║
╚════════════════════════════════════════════════════╝
```

### 3. Expenses Page (`/app/expenses`)

**Все расходы с фильтрами:**
```
╔════════════════════════════════════════════════════╗
║  💰 Расходы                    [+ Добавить]       ║
╠════════════════════════════════════════════════════╣
║  Фильтры:                                         ║
║  [Проект ▼] [Категория ▼] [Период ▼] [Сброс]    ║
║  ─────────────────────────────────────────────    ║
║  Дата       │ Проект      │ Категория │ Сумма   ║
║  ──────────────────────────────────────────────   ║
║  10.12.2024 │ Кв. Иванов  │ 🛠️ Материалы │ 500  ║
║  09.12.2024 │ Кв. Иванов  │ 🛠️ Материалы │ 300  ║
║  08.12.2024 │ Общие       │ 💡 Ком. услуги│ 100  ║
║  07.12.2024 │ Кв. Иванов  │ 🚚 Транспорт │ 400  ║
║  ──────────────────────────────────────────────   ║
║  Всего: 1,300 PLN                         [→]    ║
╚════════════════════════════════════════════════════╝
```

### 4. Dashboard - ERP Widget

**Добавить на существующий Dashboard:**
```
╔════════════════════════════════════════════════════╗
║  💼 Финансы за декабрь                            ║
╠════════════════════════════════════════════════════╣
║  Расходы на проекты:    12,500 PLN               ║
║  Общие расходы:          2,350 PLN               ║
║  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━              ║
║  Итого:                 14,850 PLN               ║
║                                                    ║
║  🔴 Проектов с превышением бюджета: 2            ║
║  🟡 Проектов близких к бюджету: 3                ║
║                                      [Подробнее →]║
╚════════════════════════════════════════════════════╝
```

═══════════════════════════════════════════════════════════════

## 🤖 TELEGRAM BOT COMMANDS

### Основные команды:

```
/start           - Начало работы
/help            - Помощь

💰 РАСХОДЫ:
/expense         - Добавить расход
/receipt         - Загрузить чек (фото)
/last            - Последние расходы

📊 ПРОЕКТЫ:
/projects        - Список проектов
/project <name>  - Сводка по проекту
/budget <name>   - Бюджет проекта

📈 ОТЧЁТЫ:
/monthly         - Месячный отчёт
/stats           - Статистика
/report          - Детальный отчёт

⚙️ НАСТРОЙКИ:
/categories      - Категории расходов
/settings        - Настройки
```

═══════════════════════════════════════════════════════════════

## 📊 ОТЧЁТЫ И АНАЛИТИКА

### 1. Месячный отчёт

```
📊 ОТЧЁТ ЗА ДЕКАБРЬ 2024

💼 Расходы на проекты:      12,500 PLN
💰 Общие расходы:            2,350 PLN
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📈 ИТОГО:                   14,850 PLN

ПО КАТЕГОРИЯМ:
🛠️ Материалы:       6,200 PLN  42%
👷 Работа:           4,500 PLN  30%
🚚 Транспорт:        1,300 PLN   9%
🏢 Офис:               800 PLN   5%
💡 Коммунальные:       650 PLN   4%
📋 Прочее:           1,400 PLN  10%

АКТИВНЫХ ПРОЕКТОВ: 8
ЗАВЕРШЁННЫХ: 2
```

### 2. Отчёт по проекту

```
📊 ПРОЕКТ: Ремонт квартиры - Иван Петров

ПЕРИОД: 01.11.2024 - 10.12.2024

💰 ФИНАНСЫ:
Бюджет:         10,000 PLN
Потрачено:       3,500 PLN (35%)
Осталось:        6,500 PLN

📈 ДИНАМИКА РАСХОДОВ:
Ноябрь:          1,200 PLN
Декабрь:         2,300 PLN

📦 ПО КАТЕГОРИЯМ:
🛠️ Материалы:    2,100 PLN (60%)
👷 Работа:        1,200 PLN (34%)
🚚 Транспорт:       200 PLN (6%)

📝 ТРАНЗАКЦИЙ: 15
📅 СРЕДНИЙ РАСХОД В ДЕНЬ: 87.50 PLN
```

═══════════════════════════════════════════════════════════════

## 🔔 УВЕДОМЛЕНИЯ И АЛЕРТЫ

### Типы уведомлений:

1. **Превышение порога бюджета**
   ```
   ⚠️ ВНИМАНИЕ!
   
   Проект: Ремонт квартиры - Иван
   Использовано: 80% бюджета
   
   Бюджет: 10,000 PLN
   Потрачено: 8,000 PLN
   Осталось: 2,000 PLN
   ```

2. **Превышение бюджета**
   ```
   🔴 КРИТИЧНО!
   
   Проект: Балкон - Мария
   ПРЕВЫШЕН БЮДЖЕТ!
   
   Бюджет: 3,000 PLN
   Потрачено: 3,200 PLN
   Перерасход: +200 PLN (+7%)
   ```

3. **Месячные итоги**
   ```
   📊 Итоги месяца
   
   Декабрь 2024 завершён
   
   Расходы: 14,850 PLN
   Проектов: 10
   Завершено: 2
   
   [Посмотреть отчёт]
   ```

═══════════════════════════════════════════════════════════════

## 🚀 ПЛАН РЕАЛИЗАЦИИ

### Фаза 1: Database & Backend (День 1-2)

- [x] Создать таблицы: projects, expenses, expense_categories, budget_alerts
- [x] Миграции и seed data
- [ ] API endpoints:
  - [ ] `/api/projects` (CRUD)
  - [ ] `/api/expenses` (CRUD)
  - [ ] `/api/expense-categories`
  - [ ] `/api/projects/:id/budget`
  - [ ] `/api/expenses/stats`

### Фаза 2: Frontend UI (День 3-4)

- [ ] Projects page
  - [ ] Список проектов
  - [ ] Детали проекта
  - [ ] Добавление расхода
- [ ] Expenses page
  - [ ] Список расходов
  - [ ] Фильтры
  - [ ] Добавление/редактирование
- [ ] Dashboard widgets
  - [ ] Финансовая сводка
  - [ ] Алерты

### Фаза 3: Telegram Bot (День 5-6)

- [ ] Команды бота:
  - [ ] `/expense` - добавить расход
  - [ ] `/project` - сводка по проекту
  - [ ] `/monthly` - месячный отчёт
- [ ] Интерактивные сценарии
- [ ] Загрузка фото чеков
- [ ] OCR распознавание (опционально)

### Фаза 4: Отчёты & Аналитика (День 7)

- [ ] Генерация отчётов
- [ ] Экспорт в PDF/Excel
- [ ] Графики и charts

### Фаза 5: Уведомления (День 8)

- [ ] Budget alerts
- [ ] Telegram notifications
- [ ] Email notifications

═══════════════════════════════════════════════════════════════

## 📝 ПРИМЕЧАНИЯ

- OCR для чеков можно реализовать через Google Vision API или Tesseract
- Фото чеков хранить в `/uploads/receipts/` или S3
- Валюта по умолчанию PLN, но поддержка мультивалютности
- Права доступа: только admin и manager могут видеть финансы

═══════════════════════════════════════════════════════════════

**Автор:** PBK CRM Team  
**Дата:** 10 декабря 2024  
**Статус:** 📋 Спецификация готова

# AI Integration Setup Guide

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å OpenAI/OpenRouter

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:

```bash
cd /root/pbk-crm-unified/backend
node tests/test-ai-integration.js
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ï—Å–ª–∏ API –∫–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  AI Integration Test - PBK CRM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üîç Testing OpenRouter Integration...
   API Key: sk-or-v1-...
   Model: google/gemini-2.0-flash-001:free
   Base URL: https://openrouter.ai/api/v1
   Response: "OpenRouter works!"
   Tokens used: 15
‚úÖ OpenRouter: OK

üîç Testing OpenAI Integration...
   API Key: sk-...
   Model: gpt-4-turbo-preview
   Response: "OpenAI works!"
   Tokens used: 12
‚úÖ OpenAI: OK

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Test Results Summary
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚úÖ OpenRouter: Working
‚úÖ OpenAI: Working

üéâ AI integration is ready!
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API –∫–ª—é—á–µ–π

### –í–∞—Ä–∏–∞–Ω—Ç 1: OpenRouter (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è - –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏)

1. –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞ https://openrouter.ai/keys
2. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:

```env
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxxxxxxxxx
OPENROUTER_MODEL=google/gemini-2.0-flash-001:free
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
```

**–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –Ω–∞ OpenRouter:**
- `google/gemini-2.0-flash-001:free` - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
- `nvidia/nemotron-nano-9b-v2:free` - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
- `meta-llama/llama-3.2-11b-vision-instruct:free`

### –í–∞—Ä–∏–∞–Ω—Ç 2: OpenAI (–ü–ª–∞—Ç–Ω—ã–π)

1. –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞ https://platform.openai.com/api-keys
2. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:

```env
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx
OPENAI_MODEL=gpt-4-turbo-preview
```

**–ú–æ–¥–µ–ª–∏ OpenAI:**
- `gpt-4-turbo-preview` - –°–∞–º–∞—è –º–æ—â–Ω–∞—è
- `gpt-4` - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è
- `gpt-3.5-turbo` - –ë—ã—Å—Ç—Ä–∞—è –∏ –¥–µ—à–µ–≤–∞—è

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ API

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ backend —Å–µ—Ä–≤–µ—Ä

```bash
cd /root/pbk-crm-unified/backend
npm start
```

### 2. –ü–æ–ª—É—á–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω

–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ AI Copilot

```bash
# –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ —á–∞—Ç–∞
curl -X POST http://localhost:5000/api/ai/copilot \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "message": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
  }'

# –¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥—ã –ø–æ–∫–∞–∑–∞ –ª–∏–¥–æ–≤
curl -X POST http://localhost:5000/api/ai/copilot \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "message": "–ü–æ–∫–∞–∂–∏ –ª–∏–¥—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã"
  }'

# –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
curl -X POST http://localhost:5000/api/ai/copilot \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "message": "–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É –∑–∞–≤—Ç—Ä–∞"
  }'

# –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É
curl -X POST http://localhost:5000/api/ai/generate-response \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "clientMessage": "–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ —Å–º–µ—Ç–∞?",
    "context": "–ö–ª–∏–µ–Ω—Ç –∑–∞–∫–∞–∑–∞–ª —Ä–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã 50 –∫–≤.–º",
    "tone": "professional"
  }'
```

## –û–∂–∏–¥–∞–µ–º—ã–µ –æ—Ç–≤–µ—Ç—ã

### –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç /api/ai/copilot:

```json
{
  "success": true,
  "message": "–ù–∞–π–¥–µ–Ω–æ 3 –ª–∏–¥–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã:\n1. –†–µ–º–æ–Ω—Ç –æ—Ñ–∏—Å–∞ - 500,000‚ÇΩ\n2. ...",
  "provider": "openrouter",
  "model": "google/gemini-2.0-flash-001:free",
  "usage": {
    "prompt_tokens": 150,
    "completion_tokens": 80,
    "total_tokens": 230
  },
  "action": {
    "type": "showLeads",
    "data": [
      {
        "id": 1,
        "title": "–†–µ–º–æ–Ω—Ç –æ—Ñ–∏—Å–∞",
        "value": 500000,
        "stage_name": "–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã"
      }
    ]
  }
}
```

### –û—à–∏–±–∫–∞ - API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:

```json
{
  "error": "AI service not configured",
  "message": "Neither OpenRouter nor OpenAI API key is configured. Please set OPENROUTER_API_KEY or OPENAI_API_KEY in environment variables."
}
```

### –û—à–∏–±–∫–∞ - –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á:

```json
{
  "error": "Invalid API key",
  "message": "AI API key is invalid. Please check your configuration."
}
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "AI service not configured"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` —Ñ–∞–π–ª - –µ—Å—Ç—å –ª–∏ `OPENROUTER_API_KEY` –∏–ª–∏ `OPENAI_API_KEY`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–ª—é—á –Ω–µ —Ä–∞–≤–µ–Ω `sk-placeholder`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `.env`

### –ü—Ä–æ–±–ª–µ–º–∞: "Invalid API key"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞
2. –î–ª—è OpenRouter: –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `sk-or-v1-`
3. –î–ª—è OpenAI: –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `sk-`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω –∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω

### –ü—Ä–æ–±–ª–µ–º–∞: "Rate limit exceeded"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã –Ω–∞ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ
3. –î–ª—è OpenRouter –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π - –æ–±—ã—á–Ω–æ –Ω–µ—Ç —Å—Ç—Ä–æ–≥–∏—Ö –ª–∏–º–∏—Ç–æ–≤
4. –î–ª—è OpenAI - –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
2. –£–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç –≤ –∫–æ–¥–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 —Å–µ–∫—É–Ω–¥)
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### OpenRouter

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: https://openrouter.ai/activity

### OpenAI

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: https://platform.openai.com/usage

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ OpenRouter —Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏** –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
2. **–ö–µ—à–∏—Ä—É–π—Ç–µ —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ CRM
3. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ max_tokens** –¥–æ —Ä–∞–∑—É–º–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (—Ç–µ–∫—É—â–µ–µ: 800)
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ temperature 0.7** –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç–æ—á–Ω–æ—Å—Ç–∏

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. ‚úÖ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` —Ñ–∞–π–ª –≤ git
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env.example` –∫–∞–∫ —à–∞–±–ª–æ–Ω
3. ‚úÖ –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ API endpoints —á–µ—Ä–µ–∑ `authenticateToken`
4. ‚úÖ –†–æ—Ç–∏—Ä—É–π—Ç–µ API –∫–ª—é—á–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ
5. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

1. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ AI Copilot –≤ frontend
2. ‚úÖ –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫ Telegram –±–æ—Ç—É
3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
4. ‚úÖ –î–æ–±–∞–≤—å—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏ –æ—Ç—á–µ—Ç—ã
